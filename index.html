<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>モスキートゲーム - 耳年齢チェック</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=M+PLUS+1p:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-bg: #1a233b;
      --secondary-bg: #2a3858;
      --accent-color: #00dffc;
      --text-color: #e0e6f2;
      --correct-color: #4dff8a;
      --incorrect-color: #ff4d4d;
    }
    * { box-sizing: border-box; user-select: none; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: 'M PLUS 1p', sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-color);
      padding: 1rem;
    }
    .main-container { max-width: 600px; margin: 0 auto; text-align: center; }
    .header { margin-bottom: 1rem; color: var(--accent-color); font-family: 'Orbitron', sans-serif; font-weight: 700; }
    #start-screen {
      background-color: var(--secondary-bg);
      border-radius: 20px;
      padding: 2rem;
      text-align: left;
    }
    #start-screen h2 {
      font-size: 1.5rem; font-weight: 700; margin: 0 0 1.5rem; display: flex; align-items: center;
    }
    #start-screen h2::before {
      content: 'ⓘ'; font-size: 1.5rem; margin-right: 0.75rem;
      color: var(--accent-color); border: 2px solid var(--accent-color);
      border-radius: 50%; width: 30px; height: 30px;
      display: inline-flex; align-items: center; justify-content: center;
    }
    #start-screen ul { list-style: none; padding: 0; margin: 0 0 2rem; line-height: 2; }
    #start-screen li {
      padding-left: 1.5rem; position: relative; margin-bottom: 0.5rem;
    }
    #start-screen li::before {
      content: '・'; position: absolute; left: 0; color: var(--accent-color);
    }
    .start-notice {
      display: flex; align-items: center; justify-content: center;
      gap: 0.5rem; margin: 2rem 0; font-weight: 500;
    }
    #start-game-button {
      width: 100%; padding: 1rem; font-size: 1.4rem;
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .hidden { display: none; }
    .question-card {
      background-color: var(--secondary-bg);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 3px solid var(--accent-color);
      transition: all 0.5s ease, border-color 1s ease;
      opacity: 0; transform: translateY(20px);
      position: relative; overflow: hidden;
    }
    .question-card.visible { opacity: 1; transform: translateY(0); }
    .question-card.answered { opacity: 0.6; }
    .level-display {
      position: absolute; top: 1rem; left: 1.5rem;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700; font-size: 1.2rem; opacity: 0.5;
    }
    @keyframes correct-glow {
      0%,100% { box-shadow: 0 0 10px var(--card-glow-color); }
      50% { box-shadow: 0 0 40px var(--card-glow-color), 0 0 10px var(--card-glow-color) inset; transform: scale(1.02); }
    }
    .correct-animation { animation: correct-glow 0.8s ease-out; }
    .frequency-display {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem; color: var(--accent-color);
      text-shadow: 0 0 10px var(--accent-color);
      text-align: center; margin-top: 1.5rem;
    }
    .controls {
      display: flex; flex-direction: column; align-items: center;
      gap: 1rem; margin: 1.5rem 0;
    }
    .play-sound-button {
      font-family: 'M PLUS 1p', sans-serif; font-weight: 700; font-size: 1.2rem;
      background-color: var(--accent-color); color: var(--primary-bg);
      border: none; border-radius: 10px; padding: 0.8rem 1.5rem;
      cursor: pointer; transition: all 0.2s ease;
    }
    .play-sound-button:hover:not(:disabled) {
      transform: scale(1.05); box-shadow: 0 0 20px var(--accent-color);
    }
    .play-sound-button:disabled {
      background-color: #555; color: #888; cursor: not-allowed;
      transform: none; box-shadow: none;
    }
    .answer-buttons {
      display: grid; grid-template-columns: repeat(3,1fr);
      gap: 1rem; width:100%;
    }
    .answer-button {
      font-family: 'Orbitron', sans-serif; font-size: 1.5rem;
      background-color: transparent; color: var(--accent-color);
      border:2px solid var(--accent-color); border-radius:10px;
      padding:1rem 0; cursor:pointer; transition:all 0.2s ease;
    }
    .answer-button:hover:not(:disabled) {
      background-color: var(--accent-color); color: var(--primary-bg);
    }
    .answer-button:disabled {
      color:#555; border-color:#555; cursor:not-allowed;
    }
    .answer-button.unknown {
      grid-column: 1 / -1; color:#aaa; border-color:#aaa;
    }
    .answer-button.unknown:hover:not(:disabled) {
      background-color:#aaa; color:var(--primary-bg);
    }
    .feedback {
      text-align:center; margin-top:1rem; font-size:1.2rem;
      font-weight:700; min-height:3.5rem;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      padding-bottom:0.5rem;
    }
    .feedback-main { font-size:1.5rem; }
    .feedback-sub { font-size:1rem; opacity:0.8; margin-top:0.2rem; }
    .feedback.correct { color:var(--correct-color); }
    .feedback.incorrect { color:var(--incorrect-color); }
    .result-screen, .ending-screen { text-align:center; }
    @media(max-width:480px) {
      .answer-buttons { grid-template-columns: repeat(2,1fr); }
      .answer-button.unknown { grid-column:auto; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="start-screen">
      <h1 class="header" style="font-size:2.2rem; margin-bottom:0.5rem;">モスキートゲーム</h1>
      <p style="font-size:1.2rem; margin-bottom:2rem;">耳年齢チェック！</p>
      <div style="background:rgba(0,0,0,0.2); padding:1.5rem; border-radius:10px;">
        <h2>ゲームの遊び方</h2>
        <ul>
          <li>高周波音のビープ音を聞いて回数を当てます</li>
          <li>レベルが上がると音の周波数が高くなります</li>
          <li>あなたの聞き取れる最高周波数で耳年齢を測定</li>
          <li>ヘッドホンまたはイヤホンの使用を推奨</li>
        </ul>
      </div>
      <p class="start-notice">🔊 音量を適切に調整してからスタート</p>
      <button class="play-sound-button" id="start-game-button">🎧 ゲームスタート</button>
    </div>
    <main id="game-area" class="hidden"></main>
    <div id="result-screen" class="result-screen hidden"></div>
    <div id="ending-screen" class="ending-screen hidden"></div>
  </div>

  <script>
    const startScreen = document.getElementById('start-screen');
    const startGameButton = document.getElementById('start-game-button');
    const gameArea = document.getElementById('game-area');
    const resultScreen = document.getElementById('result-screen');
    const endingScreen = document.getElementById('ending-screen');

    const START_FREQUENCY = 8000;
    const MAX_FREQUENCY = 22000;
    const FREQUENCY_STEP = 1000;
    const MAX_BEEPS = 5;
    const ageMapping = [
      { freq: 17000, text: "10代～20代前半" }, { freq: 16000, text: "20代" },
      { freq: 15000, text: "30代" }, { freq: 14000, text: "40代" },
      { freq: 12000, text: "50代" }, { freq: 10000, text: "60代" }, { freq: 8000,  text: "全ての年代" }
    ];
    let isPlaying = false;
    let maxReachedLevel = 1;

    // ★★★ AudioEngineクラスに効果音再生メソッドを追加 ★★★
    class AudioEngine {
      constructor() { this.audioContext = null; this.mainGainNode = null; this.oscillator = null; this.isInitialized = false; }
      async init() {
        if (this.isInitialized) return;
        try {
          this.audioContext = new (window.AudioContext||window.webkitAudioContext)();
          if (this.audioContext.state === 'suspended') { await this.audioContext.resume(); }
          this.mainGainNode = this.audioContext.createGain();
          this.mainGainNode.connect(this.audioContext.destination);
          this.mainGainNode.gain.value = 0;
          this.oscillator = this.audioContext.createOscillator();
          this.oscillator.type = 'sine';
          this.oscillator.connect(this.mainGainNode);
          this.oscillator.start();
          this.isInitialized = true;
        } catch (e) { alert('オーディオ機能の初期化に失敗しました。'); }
      }
      async playBeep(frequency, duration, volume) {
        if (!this.isInitialized) return;
        const now = this.audioContext.currentTime;
        this.oscillator.frequency.setValueAtTime(frequency, now);
        this.mainGainNode.gain.cancelScheduledValues(now);
        this.mainGainNode.gain.setValueAtTime(0, now);
        this.mainGainNode.gain.linearRampToValueAtTime(volume, now + 0.01);
        this.mainGainNode.gain.linearRampToValueAtTime(0, now + duration - 0.01);
        return new Promise(resolve => setTimeout(resolve, duration * 1000));
      }
      // --- ▼▼▼ 追加した効果音再生メソッド ▼▼▼ ---
      playFeedbackSound(type) {
        if (!this.isInitialized) return;
        const now = this.audioContext.currentTime;
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        osc.connect(gain);
        gain.connect(this.audioContext.destination);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.5, now + 0.01);

        if (type === 'correct') { // ピンポン
          osc.type = 'sine';
          osc.frequency.setValueAtTime(987.77, now); // B5
          gain.gain.linearRampToValueAtTime(0, now + 0.2);
          setTimeout(() => {
              const osc2 = this.audioContext.createOscillator();
              const gain2 = this.audioContext.createGain();
              osc2.connect(gain2);
              gain2.connect(this.audioContext.destination);
              osc2.type = 'sine';
              osc2.frequency.setValueAtTime(1318.51, now + 0.15); // E6
              gain2.gain.setValueAtTime(0, now + 0.15);
              gain2.gain.linearRampToValueAtTime(0.5, now + 0.16);
              gain2.gain.linearRampToValueAtTime(0, now + 0.4);
              osc2.start(now + 0.15);
              osc2.stop(now + 0.5);
          }, 0);
        } else { // ブブー
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(160, now);
          osc.frequency.exponentialRampToValueAtTime(100, now + 0.4);
          gain.gain.linearRampToValueAtTime(0, now + 0.5);
        }
        osc.start(now);
        osc.stop(now + 0.5);
      }
    }
    const audioEngine = new AudioEngine();

    // 補助関数
    const compliments = {
      easy:   ["いいね！","その調子！","すごい！"],
      medium: ["すごい集中力！","才能あるかも？","よく聞いてるね！"],
      hard:   ["天才的！","神の耳だ！","信じられない！"]
    };
    function getCompliment(level) {
      const list = level <= 5 ? compliments.easy : level <= 10 ? compliments.medium : compliments.hard;
      return list[Math.floor(Math.random()*list.length)];
    }
    function getEarAgeText(level) {
      const freq = START_FREQUENCY + (level-1)*FREQUENCY_STEP;
      for (const m of ageMapping) { if (freq >= m.freq) return m.text; }
      return "測定不能";
    }
    function showScreen(screen) {
      [startScreen, gameArea, resultScreen, endingScreen].forEach(s=>s.classList.add('hidden'));
      screen.classList.remove('hidden');
    }

    // ゲームの初期化/リスタート
    async function startGame() {
        maxReachedLevel = 1;
        gameArea.innerHTML = '';
        createQuestionCard(START_FREQUENCY, 1);
        showScreen(gameArea);
    }
    
    // 問題カード生成
    function createQuestionCard(frequency, level) {
      maxReachedLevel = Math.max(maxReachedLevel, level);
      const correctAnswer = Math.floor(Math.random()*MAX_BEEPS)+1;
      gameArea.innerHTML = '';

      const card = document.createElement('div');
      card.className = 'question-card';
      const icons = ['🎵','✨','🚀','👑','🏆'];
      const icon = icons[Math.floor((level-1)/3)]||'💀';
      const hue = 200-((frequency-START_FREQUENCY)/(MAX_FREQUENCY-START_FREQUENCY))*200;
      const borderColor = `hsl(${hue},80%,60%)`;
      card.style.borderColor = borderColor;
      card.style.setProperty('--card-glow-color', borderColor);

      card.innerHTML = `
        <div class="level-display">LEVEL ${level} ${icon}</div>
        <div class="frequency-display">${frequency} Hz</div>
        <div class="controls">
          <button class="play-sound-button">音を再生する</button>
          <div class="answer-buttons">
            ${[1,2,3,4,5].map(i=>`<button class="answer-button" data-answer="${i}">${i}</button>`).join('')}
            <button class="answer-button unknown" data-answer="unknown">わからない</button>
          </div>
        </div>
        <div class="feedback"></div>`;

      gameArea.appendChild(card);

      const playBtn   = card.querySelector('.play-sound-button');
      const answerBtns = card.querySelectorAll('.answer-button');
      const feedbackEl = card.querySelector('.feedback');

      playBtn.addEventListener('click', async () => {
        if (isPlaying) return;
        isPlaying = true;
        playBtn.disabled = true;
        for (let i=0; i<correctAnswer; i++) {
          await audioEngine.playBeep(frequency, 0.1, 0.7);
          await new Promise(r=>setTimeout(r,150));
        }
        isPlaying = false;
        if (!card.classList.contains('answered')) playBtn.disabled = false;
      });

      answerBtns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (isPlaying) return;
          answerBtns.forEach(b=>b.disabled=true);
          playBtn.disabled = true;
          card.classList.add('answered');
          const ua = btn.dataset.answer;
          const correct = ua!=='unknown' && +ua===correctAnswer;

          if (correct) {
            audioEngine.playFeedbackSound('correct'); // ★★★ 正解音を再生 ★★★
            feedbackEl.innerHTML = `<div class="feedback-main">正解！</div><div class="feedback-sub">${getCompliment(level)}</div>`;
            feedbackEl.classList.add('correct');
            card.classList.add('correct-animation');
            const nextF = frequency+FREQUENCY_STEP;
            if (nextF>MAX_FREQUENCY) {
              setTimeout(showEndingScreen,1200);
            } else {
              setTimeout(()=>createQuestionCard(nextF, level+1),1200);
            }
          } else {
            audioEngine.playFeedbackSound('incorrect'); // ★★★ 不正解音を再生 ★★★
            feedbackEl.classList.add('incorrect');
            const msg = ua==='unknown'
              ? `<div class="feedback-main">正解は ${correctAnswer} 回でした</div>`
              : `<div class="feedback-main">ざんねん…</div>`;
            feedbackEl.innerHTML = msg+`<div class="feedback-sub" style="margin-top:.5rem;">どうしますか？</div>`;

            const choices = document.createElement('div');
            choices.style.cssText = 'display:grid;grid-template-columns:repeat(2,1fr);gap:.8rem;margin-top:1rem;width:100%;max-width:400px;margin:1rem auto 0;';
            const mkBtn = (text,bg,fn)=>{
              const b=document.createElement('button');
              b.className='play-sound-button';
              b.textContent=text;
              b.style.fontSize='1rem'; b.style.padding='0.7rem 0.5rem';
              if(bg) b.style.backgroundColor=bg;
              b.onclick=fn;
              return b;
            };
            if(level>1) {
              const back=mkBtn(`Lv.${level-1} に戻る`,'var(--text-color)',()=>createQuestionCard(frequency-FREQUENCY_STEP, level-1));
              back.style.color='var(--primary-bg)';
              choices.appendChild(back);
            }
            choices.appendChild(mkBtn(`もう一度 Lv.${level}`,null,()=>createQuestionCard(frequency, level)));
            choices.appendChild(mkBtn('はじめから','#8892b0',()=>{ if(confirm('本当にはじめからやり直しますか？')) startGame(); }));
            choices.appendChild(mkBtn('終了する','#e57373',()=>{ if(confirm('チャレンジを終了して結果を見ますか？')) showResultScreen(); }));
            feedbackEl.appendChild(choices);
          }
        });
      });

      setTimeout(()=>{
        card.classList.add('visible');
        card.scrollIntoView({behavior:'smooth',block:'center'});
      },100);
    }

    function showResultScreen() {
      const age = getEarAgeText(maxReachedLevel);
      resultScreen.innerHTML = `
      <div class="question-card visible" style="border-color:var(--accent-color);">
        <h1>チャレンジ結果</h1>
        <p style="font-size:1.2rem;">LEVEL ${maxReachedLevel}</p>
        <p style="font-size:1.2rem;margin-top:1rem;">${age} 相当です！</p>
        <button class="play-sound-button" id="restart-button-result" style="margin-top:2rem;">もう一度挑戦する</button>
      </div>`;
      showScreen(resultScreen);
      document.getElementById('restart-button-result').addEventListener('click', startGame);
    }
    function showEndingScreen() {
      const finalLevel = Math.floor((MAX_FREQUENCY-START_FREQUENCY)/FREQUENCY_STEP)+1;
      const age = getEarAgeText(finalLevel);
      endingScreen.innerHTML = `
      <div class="question-card visible" style="border-color:gold;">
        <h1>CONGRATULATIONS!</h1>
        <p style="font-size:1.2rem;">${age} 相当です！</p>
        <button class="play-sound-button" id="restart-button-end" style="margin-top:2rem;">もう一度挑戦する</button>
      </div>`;
      showScreen(endingScreen);
      document.getElementById('restart-button-end').addEventListener('click', startGame);
    }

    startGameButton.addEventListener('click', async () => {
      if (startGameButton.disabled) return;
      startGameButton.disabled = true;
      startGameButton.textContent = '準備中...';
      await audioEngine.init();
      startGame();
    }, { once: true });

  </script>
</body>
</html>